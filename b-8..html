<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>麻糬永遠最上層</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  height: 100vh;
  overflow: hidden;
  font-family: sans-serif;
  background: linear-gradient(to bottom,#fff0f6,#ffe3ec 40%,#f5f0e1);
}

#scene {
  position: relative;
  width: 100%;
  height: 100vh;
  overflow: hidden;
}

/* 日光暈 */
#scene::before {
  content: "";
  position: absolute;
  top: -200px;
  left: 50%;
  transform: translateX(-50%);
  width: 600px;
  height: 600px;
  background: radial-gradient(circle,
    rgba(255,255,255,0.8) 0%,
    rgba(255,255,255,0.4) 30%,
    rgba(255,255,255,0) 65%);
  z-index: 0;
}

/* 臼 */
#usu {
  position: absolute;
  width: 220px;
  height: 140px;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(to bottom,#e6b87e,#cfa063);
  border-radius: 50% / 30%;
  z-index: 1;
}

/* 麻糬 */
#mochi {
  position: fixed;
  bottom: 50px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 80px;
  background: pink;
  border-radius: 50%;
  z-index: 2147483647;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: none;
  user-select: none;
  box-shadow:
    inset -5px -5px 15px rgba(255,255,255,0.5),
    inset 5px 5px 15px rgba(0,0,0,0.1);
}

/* 豆豆眼 */
.eye {
  position: absolute;
  width: 10px;
  height: 10px;
  background: black;
  border-radius: 50%;
  top: 35%;
  animation: eyeFloat 2.5s ease-in-out infinite;
  transition: transform .08s, opacity .1s;
}
.eye.left { left: 25%; }
.eye.right { left: 55%; }

@keyframes eyeFloat {
  0% { transform: translate(0,0); }
  50% { transform: translate(2px,1px); }
  100% { transform: translate(0,0); }
}

/* 嘴巴 */
.mouth {
  position: absolute;
  bottom: 25%;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 3px;
  background: black;
  border-radius: 2px;
}

/* 氣球碎片 */
.balloon-piece {
  position: absolute;
  width: 26px;
  height: 14px;
  border-radius: 60% 40% 60% 40%;
  pointer-events: none;
  z-index: 500;
}

/* 櫻花 */
.petal {
  position: absolute;
  width: 14px;
  height: 10px;
  background: radial-gradient(ellipse at top left,#ffe6ef,#ffb7cf);
  border-radius: 60% 40% 60% 40%;
  opacity: .8;
  animation: fall linear infinite;
}

@keyframes fall {
  from { transform: translateY(-10vh) rotate(0deg); opacity: 0; }
  10% { opacity: 1; }
  to { transform: translate(-80px,120vh) rotate(360deg); opacity: 0; }
}

/* 調色盤 */
#colorPicker {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 10000;
}
</style>
</head>

<body>

<input type="color" id="colorPicker">

<div id="scene">
  <div id="usu"></div>
  <div id="mochi">
    <div class="eye left"></div>
    <div class="eye right"></div>
    <div class="mouth"></div>
  </div>
</div>

<script>
const mochi = document.getElementById("mochi");
const scene = document.getElementById("scene");
const eyeL = document.querySelector(".eye.left");
const eyeR = document.querySelector(".eye.right");
const mouth = document.querySelector(".mouth");
const picker = document.getElementById("colorPicker");

picker.oninput = e => mochi.style.background = e.target.value;

let size = 80;
const MAX = 800;
let timer = null;

/* 音效 */
const ctx = new (window.AudioContext||window.webkitAudioContext)();
let osc,gain;
function soundOn(){
  osc=ctx.createOscillator();gain=ctx.createGain();
  osc.frequency.value=180;gain.gain.value=.12;
  osc.connect(gain);gain.connect(ctx.destination);
  osc.start();
}
function soundUpdate(){
  if(osc)osc.frequency.value=180+(size-80)*.3;
}
function soundOff(){
  if(osc){osc.stop();osc.disconnect();gain.disconnect();osc=null;}
}

/* 拉伸 */
function startStretch(){
  ctx.resume();soundOn();
  timer=setInterval(()=>{
    size+=6;
    if(size>=MAX) return explode();

    mochi.style.width=mochi.style.height=size+"px";
    mouth.style.width=Math.min((size-80)*.4,20)+"px";

    const s=Math.min((size-80)/120,1);
    eyeL.style.transform=`translate(${8+s*6}px,${2+s*2}px) scale(${1-s*.4},${1+s*.2})`;
    eyeR.style.transform=`translate(${-8-s*6}px,${2+s*2}px) scale(${1-s*.4},${1+s*.2})`;

    if(size>MAX*.85){
      const j=(Math.random()-.5)*3;
      eyeL.style.transform+=` translate(${j}px,${j}px)`;
      eyeR.style.transform+=` translate(${j}px,${j}px)`;
    }

    soundUpdate();
  },50);
}

function stopStretch(){
  clearInterval(timer);
  soundOff();
  size=80;
  mochi.style.width=mochi.style.height="80px";
  mouth.style.width="0";
  eyeL.style.transform=eyeR.style.transform="";
}

/* 氣球爆炸 */
function explode(){
  clearInterval(timer);soundOff();
  const r=mochi.getBoundingClientRect();
  eyeL.style.opacity=eyeR.style.opacity=0;
  mochi.style.visibility="hidden";

  for(let i=0;i<18;i++){
    const p=document.createElement("div");
    p.className="balloon-piece";
    p.style.background=mochi.style.background;
    p.style.left=r.left+r.width/2+"px";
    p.style.top=r.top+r.height/2+"px";
    scene.appendChild(p);

    const a=Math.random()*Math.PI*2,d=120+Math.random()*180,rot=(Math.random()-.5)*720;
    p.animate([
      {transform:"scale(1)",opacity:1},
      {transform:`translate(${Math.cos(a)*d}px,${Math.sin(a)*d}px) scale(.6) rotate(${rot}deg)`,opacity:0}
    ],{duration:700,easing:"cubic-bezier(.2,.8,.2,1)"});
    setTimeout(()=>p.remove(),700);
  }

  setTimeout(()=>{
    size=80;
    mochi.style.visibility="visible";
    mochi.style.width=mochi.style.height="80px";
    eyeL.style.opacity=eyeR.style.opacity=1;
    eyeL.style.transform=eyeR.style.transform="";
  },750);
}

/* 操作 */
mochi.onmousedown=e=>{e.preventDefault();startStretch();}
document.onmouseup=stopStretch;
mochi.ontouchstart=e=>{e.preventDefault();startStretch();}
mochi.ontouchend=stopStretch;

/* 櫻花 */
function petal(){
  const p=document.createElement("div");
  p.className="petal";
  p.style.left=Math.random()*100+"vw";
  p.style.animationDuration=10+Math.random()*8+"s";
  scene.appendChild(p);
  setTimeout(()=>p.remove(),18000);
}
for(let i=0;i<20;i++)petal();
setInterval(petal,1200);
</script>

</body>
</html>
